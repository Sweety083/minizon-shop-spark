pipeline {
    agent any

    environment {
        // ‚úÖ Replace with your actual registry (e.g., docker.io/sweetyraj or ghcr.io/username)
        DOCKER_REGISTRY = 'docker.io/sweetyraj'
        IMAGE_NAME = 'minizon-shop-spark'
        
        // ‚úÖ Use Jenkins credentials
        KUBECONFIG_CRED = credentials('kubeconfig')
        DOCKER_CRED = credentials('docker-credentials')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üì¶ Checking out source code..."
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "üì• Installing dependencies..."
                sh 'npm ci'
            }
        }

        stage('Lint') {
            steps {
                echo "üßπ Running lint checks..."
                sh 'npm run lint || echo "Lint warnings detected, continuing..."'
            }
        }

        stage('Build') {
            steps {
                echo "üèóÔ∏è Building production build..."
                sh 'npm run build'
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo "üß™ Running tests..."
                sh 'npm test -- --watchAll=false --coverage'
            }
            post {
                always {
                    junit 'test-results.xml'
                    cobertura coberturaReportFile: 'coverage/cobertura-coverage.xml'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "üê≥ Building Docker image..."
                    def image = docker.build("${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER}")
                    
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CRED}") {
                        image.push()
                        image.push("latest")
                    }
                }
            }
        }

        stage('Security Scan') {
            steps {
                echo "üîí Scanning image with Trivy..."
                sh 'docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image ${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} || true'
            }
        }

        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                echo "üöÄ Deploying to Staging environment..."
                withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
                    sh '''
                        mkdir -p ~/.kube
                        cp $KUBECONFIG_FILE ~/.kube/config
                        kubectl config use-context staging
                        kubectl set image deployment/minizon-frontend minizon-frontend=${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} -n minizon-staging
                        kubectl rollout status deployment/minizon-frontend -n minizon-staging
                    '''
                }
            }
        }

        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                echo "üöÄ Deploying to Production environment..."
                withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
                    sh '''
                        mkdir -p ~/.kube
                        cp $KUBECONFIG_FILE ~/.kube/config
                        kubectl config use-context production
                        kubectl set image deployment/minizon-frontend minizon-frontend=${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} -n minizon
                        kubectl rollout status deployment/minizon-frontend -n minizon
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up workspace..."
            cleanWs()
        }
        success {
            echo "‚úÖ Deployment successful!"
            slackSend channel: '#deployments', message: "‚úÖ *${env.JOB_NAME}* build *#${env.BUILD_NUMBER}* deployed successfully!"
        }
        failure {
            echo "‚ùå Deployment failed!"
            slackSend channel: '#deployments', message: "‚ùå *${env.JOB_NAME}* build *#${env.BUILD_NUMBER}* failed."
        }
    }
}
